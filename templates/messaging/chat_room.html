{% extends 'base.html' %}
{% block title %}Chat with {{ other_user.username }} - Campus Lost & Found{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex; flex-direction: column;
        height: calc(100vh - 200px); min-height: 500px;
        background: #fff; border-radius: 16px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.10); overflow: hidden;
    }
    .chat-header {
        background: linear-gradient(135deg, #2c3e8c, #1a2564);
        color: white; padding: 16px 20px;
        display: flex; align-items: center; gap: 14px; flex-shrink: 0;
    }
    .chat-avatar {
        width: 42px; height: 42px; background: rgba(255,255,255,0.2);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem; font-weight: 700; flex-shrink: 0;
    }
    .chat-header-info { flex: 1; }
    .chat-header-name { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
    .chat-header-sub { font-size: 0.78rem; opacity: 0.85; }
    .online-dot {
        width: 10px; height: 10px; background: #2ecc71; border-radius: 50%;
        display: inline-block; margin-right: 5px; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    .item-chip {
        background: rgba(255,255,255,0.15); border-radius: 20px;
        padding: 5px 12px; font-size: 0.78rem;
        display: flex; align-items: center; gap: 6px;
        text-decoration: none; color: white; transition: background 0.2s;
    }
    .item-chip:hover { background: rgba(255,255,255,0.25); color: white; }

    .chat-messages {
        flex: 1; overflow-y: auto; padding: 20px;
        display: flex; flex-direction: column; gap: 10px;
        background: #f5f6fa;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: #dee2e6; border-radius: 4px; }

    .msg-row { display: flex; align-items: flex-end; gap: 8px; animation: fadeSlideUp 0.25s ease; }
    @keyframes fadeSlideUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
    .msg-row.own { flex-direction: row-reverse; }

    .msg-avatar {
        width: 30px; height: 30px; border-radius: 50%;
        background: #2c3e8c; color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75rem; font-weight: 700; flex-shrink: 0;
    }
    .msg-avatar.own-av { background: #6c757d; }

    .msg-bubble {
        max-width: 65%; padding: 10px 14px; border-radius: 18px;
        font-size: 0.92rem; line-height: 1.45; word-break: break-word;
    }
    .msg-bubble.other {
        background: white; color: #212529;
        border-bottom-left-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .msg-bubble.own {
        background: linear-gradient(135deg, #2c3e8c, #1a2564);
        color: white; border-bottom-right-radius: 4px;
    }
    .msg-time { font-size: 0.68rem; opacity: 0.65; margin-top: 3px; display: block; }
    .msg-bubble.other .msg-time { text-align: left; }
    .msg-bubble.own .msg-time { text-align: right; }

    .empty-chat {
        flex: 1; display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        color: #adb5bd; text-align: center; padding: 40px;
    }

    .conn-banner {
        padding: 6px 16px; font-size: 0.78rem;
        display: flex; align-items: center; gap: 8px;
        flex-shrink: 0; transition: all 0.3s;
    }
    .conn-banner.live   { background:#d1fae5; color:#065f46; }
    .conn-banner.poll   { background:#fef9c3; color:#854d0e; }
    .conn-banner.error  { background:#fee2e2; color:#991b1b; }
    .conn-banner .dot   { width:8px;height:8px;border-radius:50%;background:currentColor; }

    .chat-input-area {
        background: white; padding: 14px 16px; border-top: 1px solid #e9ecef;
        display: flex; gap: 10px; align-items: flex-end; flex-shrink: 0;
    }
    #messageInput {
        flex: 1; border: 1.5px solid #dee2e6; border-radius: 24px;
        padding: 10px 16px; font-size: 0.92rem; resize: none;
        max-height: 120px; outline: none; transition: border-color 0.2s; font-family: inherit;
    }
    #messageInput:focus { border-color: #2c3e8c; }
    #sendBtn {
        width: 44px; height: 44px; border-radius: 50%;
        background: linear-gradient(135deg, #2c3e8c, #1a2564);
        color: white; border: none;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; flex-shrink: 0; transition: transform 0.15s;
    }
    #sendBtn:hover { transform: scale(1.08); }
    #sendBtn:active { transform: scale(0.95); }

    @media(min-width:992px){ .chat-container{ height: calc(100vh - 160px); } }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 px-3 px-md-4" style="max-width:1100px;">
    <div class="row g-3">

        <!-- Sidebar -->
        <div class="col-lg-3 d-none d-lg-block">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold text-muted mb-3 small text-uppercase">Item Info</h6>
                    {% if item.image %}
                    <img src="{{ item.image.url }}" class="img-fluid rounded-3 mb-3" style="width:100%;height:140px;object-fit:cover;">
                    {% endif %}
                    <div class="fw-bold mb-1">{{ item.title }}</div>
                    <div class="mb-2">
                        {% if item.status == 'Lost' %}<span class="badge bg-danger">Lost</span>
                        {% elif item.status == 'Found' %}<span class="badge bg-success">Found</span>
                        {% else %}<span class="badge bg-secondary">Returned</span>{% endif %}
                    </div>
                    <div class="small text-muted mb-1"><i class="bi bi-geo-alt me-1"></i>{{ item.location }}</div>
                    <div class="small text-muted mb-3"><i class="bi bi-person me-1"></i>{{ item.posted_by.username }}</div>
                    <a href="{% url 'item_detail' item.pk %}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-eye me-1"></i>View Item
                    </a>
                </div>
            </div>
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-body">
                    <h6 class="fw-bold text-muted mb-3 small text-uppercase">Chatting With</h6>
                    <div class="d-flex align-items-center gap-2">
                        <div style="width:38px;height:38px;background:#e8eaf6;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2c3e8c;">
                            {{ other_user.username|first|upper }}
                        </div>
                        <div>
                            <div class="fw-semibold">{{ other_user.username }}</div>
                            <div class="small text-muted">{{ other_user.email }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <a href="{% url 'inbox' %}" class="btn btn-outline-secondary btn-sm w-100 mt-3">
                <i class="bi bi-arrow-left me-1"></i>Back to Inbox
            </a>
        </div>

        <!-- Chat -->
        <div class="col-lg-9">
            <div class="chat-container">

                <!-- Header -->
                <div class="chat-header">
                    <a href="{% url 'inbox' %}" class="text-white me-1 d-lg-none" style="font-size:1.2rem;">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <div class="chat-avatar">{{ other_user.username|first|upper }}</div>
                    <div class="chat-header-info">
                        <div class="chat-header-name">{{ other_user.username }}</div>
                        <div class="chat-header-sub" id="headerSub">
                            <span class="online-dot" id="onlineDot"></span>
                            <span id="statusText">Connecting...</span>
                        </div>
                    </div>
                    <a href="{% url 'item_detail' item.pk %}" class="item-chip d-none d-md-flex">
                        <i class="bi bi-tag"></i>{{ item.title|truncatechars:22 }}
                    </a>
                </div>

                <!-- Connection Banner -->
                <div class="conn-banner live" id="connBanner">
                    <div class="dot"></div>
                    <span id="connText">Connecting to live chat...</span>
                </div>

                <!-- Messages -->
                <div class="chat-messages" id="chatMessages">
                    {% if not chat_messages %}
                    <div class="empty-chat" id="emptyState">
                        <i class="bi bi-chat-dots" style="font-size:3.5rem;margin-bottom:12px;"></i>
                        <div class="fw-semibold">No messages yet</div>
                        <div class="small mt-1">Say hi to start the conversation!</div>
                    </div>
                    {% else %}
                    {% for msg in chat_messages %}
                    <div class="msg-row {% if msg.sender == request.user %}own{% endif %}" data-msg-id="{{ msg.id }}">
                        {% if msg.sender != request.user %}
                        <div class="msg-avatar">{{ msg.sender.username|first|upper }}</div>
                        {% endif %}
                        <div class="msg-bubble {% if msg.sender == request.user %}own{% else %}other{% endif %}">
                            {{ msg.content }}
                            <span class="msg-time">{{ msg.timestamp|date:"H:i" }}</span>
                        </div>
                        {% if msg.sender == request.user %}
                        <div class="msg-avatar own-av">{{ msg.sender.username|first|upper }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                <!-- Input -->
                <div class="chat-input-area">
                    <textarea id="messageInput" placeholder="Type a message..." rows="1" maxlength="2000"></textarea>
                    <button id="sendBtn" title="Send">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const CONVERSATION_ID = "{{ conversation.id }}";
const CURRENT_USER_ID = "{{ request.user.id }}";
const CURRENT_USERNAME = "{{ request.user.username|escapejs}}";
const OTHER_USERNAME    = "{{ other_user.username|escapejs}}";
const POLL_URL = "{% url 'poll_messages' conversation.id %}";
const CSRF_TOKEN = "{{ csrf_token }}";

const chatMessages  = document.getElementById('chatMessages');
const messageInput  = document.getElementById('messageInput');
const sendBtn       = document.getElementById('sendBtn');
const connBanner    = document.getElementById('connBanner');
const connText      = document.getElementById('connText');
const statusText    = document.getElementById('statusText');
const onlineDot     = document.getElementById('onlineDot');
const emptyState    = document.getElementById('emptyState');

// Track highest message id we've rendered (avoids duplicates)
let lastSeenId = 0;
document.querySelectorAll('[data-msg-id]').forEach(el => {
    lastSeenId = Math.max(lastSeenId, parseInt(el.dataset.msgId) || 0);
});

let socket = null;
let socketOpen = false;
let pollInterval = null;

// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    socket = new WebSocket(`${proto}//${location.host}/ws/chat/${CONVERSATION_ID}/`);

    socket.onopen = () => {
        socketOpen = true;
        stopPolling();
        setBanner('live', 'ðŸŸ¢ Live â€” messages appear instantly');
        setStatus('Live');
    };

    socket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        // Only render if we haven't already rendered this message id
        if (data.message_id && data.message_id <= lastSeenId) return;
        if (data.message_id) lastSeenId = data.message_id;
        if (emptyState) emptyState.remove();
        appendBubble(data);
    };

    socket.onclose = () => {
        socketOpen = false;
        setBanner('poll', 'ðŸŸ¡ Offline â€” checking for new messages every 3s...');
        setStatus('Offline');
        startPolling();
        // Try to reconnect WebSocket after 5s
        setTimeout(connectWS, 5000);
    };

    socket.onerror = () => {
        socket.close();
    };
}

// â”€â”€â”€ HTTP Polling Fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// This ensures the recipient ALWAYS gets messages even when WS is closed.
// Messages were already saved to DB by the sender's consumer.
function startPolling() {
    if (pollInterval) return;
    pollInterval = setInterval(fetchNewMessages, 3000);
    fetchNewMessages(); // immediate first fetch
}

function stopPolling() {
    if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
}

async function fetchNewMessages() {
    try {
        const res = await fetch(`${POLL_URL}?after=${lastSeenId}`);
        const data = await res.json();
        data.messages.forEach(msg => {
            if (msg.id <= lastSeenId) return;
            lastSeenId = msg.id;
            if (emptyState) emptyState.remove();
            appendBubble(msg);
        });
    } catch(e) {
        setBanner('error', 'ðŸ”´ Connection error â€” retrying...');
    }
}

// â”€â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage() {
    const content = messageInput.value.trim();
    if (!content) return;

    if (socketOpen && socket.readyState === WebSocket.OPEN) {
        // Send via WebSocket â€” consumer saves to DB + broadcasts
        socket.send(JSON.stringify({ message: content }));
    } else {
        // WebSocket offline: POST directly to save in DB
        // Other user will get it via polling
        sendViaHTTP(content);
    }

    messageInput.value = '';
    messageInput.style.height = 'auto';
    messageInput.focus();
}

async function sendViaHTTP(content) {
    try {
        const res = await fetch(`${POLL_URL}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: JSON.stringify({ message: content }),
        });
        const data = await res.json();
        if (data.message) {
            if (emptyState) emptyState.remove();
            lastSeenId = data.message.id;
            appendBubble({ ...data.message, is_own: true });
        }
    } catch(e) {
        alert('Failed to send message. Please check your connection.');
    }
}

// â”€â”€â”€ Render Bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendBubble({ message, sender_username, sender_id, timestamp, is_own, id }) {
    const row = document.createElement('div');
    row.className = 'msg-row' + (is_own ? ' own' : '');
    if (id) row.dataset.msgId = id;
    const init = (sender_username || 'U').charAt(0).toUpperCase();

    if (!is_own) row.innerHTML += `<div class="msg-avatar">${init}</div>`;
    row.innerHTML += `
        <div class="msg-bubble ${is_own ? 'own' : 'other'}">
            ${escapeHtml(message)}
            <span class="msg-time">${timestamp}</span>
        </div>`;
    if (is_own)  row.innerHTML += `<div class="msg-avatar own-av">${init}</div>`;

    chatMessages.appendChild(row);
    scrollToBottom();
}

// â”€â”€â”€ UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setBanner(state, text) {
    connBanner.className = 'conn-banner ' + state;
    connText.textContent = text;
}

function setStatus(text) {
    statusText.textContent = text;
    onlineDot.style.background = text === 'Live' ? '#2ecc71' : '#f39c12';
}

function escapeHtml(t) {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(t));
    return d.innerHTML;
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
scrollToBottom();
connectWS();
</script>
{% endblock %}
